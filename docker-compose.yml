version: "3.7"
services: 
    proxy:
        build: 
            context: .
            dockerfile: Containerfile-proxy
        container_name: "${CONTAINER_NAME_PROXY:-proxy-instance}"
        environment:
            - CONTAINER_NAME_PROXY=${CONTAINER_NAME_PROXY:-proxy-instance}
            - CONTAINER_NAME_CDN=${CONTAINER_NAME_CDN:-cdn-instance}
            - CONTAINER_NAME_SITE=${CONTAINER_NAME_SITE:-site-instance}
        networks:
            - app-network
            - app-internal
        ports:
            - "80:80"
            - "443:443"
        depends_on:
            - site
            - cdn
        links: 
            - site
            - cdn
        restart: always

    cdn:
        container_name: "${CONTAINER_NAME_CDN:-cdn-instance}"
        environment:
            - CONTAINER_SOURCE=cdn
            - CONTAINER_NAME_PROXY=${CONTAINER_NAME_PROXY:-proxy-instance}
            - CONTAINER_NAME_CDN=${CONTAINER_NAME_CDN:-cdn-instance}
            - CONTAINER_NAME_SITE=${CONTAINER_NAME_SITE:-site-instance}
        build: 
            context: .
            dockerfile: Containerfile-nginx
        volumes:
            - ./test-site/media:/var/www/media:ro
            - ./test-site/css:/var/www/css:ro
        networks: 
            - app-internal
        ports:
            - "8080:80"
        restart: always

    site:
        container_name: "${CONTAINER_NAME_SITE:-site-instance}"
        environment:
            - CONTAINER_SOURCE=site
            - CONTAINER_NAME_PROXY=${CONTAINER_NAME_PROXY:-proxy-instance}
            - CONTAINER_NAME_CDN=${CONTAINER_NAME_CDN:-cdn-instance}
            - CONTAINER_NAME_SITE=${CONTAINER_NAME_SITE:-site-instance}
        build: 
            context: .
            dockerfile: Containerfile-nginx
        volumes:
            - ./test-site/html:/var/www:ro
        networks:
            - app-internal
        ports:
            - "8081:80"
        restart: always

# Place site and cdn servers on an internal network. All access should be through the proxy.
networks:
    app-network:
        driver: bridge
        internal: false
        
    app-internal:
        driver: bridge
        internal: true        
